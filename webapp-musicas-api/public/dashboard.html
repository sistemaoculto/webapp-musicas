<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
</head>
<body>

<h2>Dashboard</h2>
<button id="logoutBtn">Sair</button>
<p id="status"></p>

<hr>

<h3>Cadastrar música</h3>
<input id="cantor" placeholder="Cantor"><br><br>
<input id="musica" placeholder="Música"><br><br>
<input id="tom" placeholder="Tom"><br><br>
<input id="link" placeholder="Link"><br><br>
<button id="saveBtn">Salvar</button>
<p id="msg"></p>

<hr>

<h3>Buscar</h3>
<input id="busca" placeholder="Digite cantor ou música" autocomplete="off">
<div id="sugestoes"></div>

<h3>Resultados</h3>
<ul id="lista"></ul>

<script>
  const API_BASE = "https://webapp-musicas.onrender.com";

  const token = localStorage.getItem("token");
  if (!token) window.location.href = "index.html";

  const status = document.getElementById("status");
  const msg = document.getElementById("msg");
  const lista = document.getElementById("lista");
  const sugestoes = document.getElementById("sugestoes");

  const cantorEl = document.getElementById("cantor");
  const musicaEl = document.getElementById("musica");
  const tomEl = document.getElementById("tom");
  const linkEl = document.getElementById("link");
  const saveBtn = document.getElementById("saveBtn");
  const buscaEl = document.getElementById("busca");
  const logoutBtn = document.getElementById("logoutBtn");

  async function api(path, opts = {}) {
    const r = await fetch(`${API_BASE}${path}`, {
      ...opts,
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`,
        ...(opts.headers || {})
      }
    });

    const data = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(data.error || "Erro na API");
    return data;
  }

  async function carregar(q = "") {
    lista.innerHTML = "<li>Carregando...</li>";
    const items = await api(`/api/songs${q ? `?q=${encodeURIComponent(q)}` : ""}`, { method: "GET" });

    if (!items.length) {
      lista.innerHTML = "<li>Nenhuma música</li>";
      return;
    }

    lista.innerHTML = "";
    for (const s of items) {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${s.cantor}</strong> - ${s.musica} (${s.tom || "-"}) ${s.link ? `- <a target="_blank" href="${s.link}">link</a>` : ""}`;
      lista.appendChild(li);
    }
  }

  saveBtn.onclick = async () => {
    msg.innerText = "Salvando...";
    try {
      await api("/api/songs", {
        method: "POST",
        body: JSON.stringify({
          cantor: cantorEl.value,
          musica: musicaEl.value,
          tom: tomEl.value,
          link: linkEl.value
        })
      });

      msg.innerText = "✅ Salvo!";
      cantorEl.value = musicaEl.value = tomEl.value = linkEl.value = "";

      await carregar(buscaEl.value.trim());
    } catch (e) {
      msg.innerText = "❌ " + e.message;
    }
  };

  let timer = null;
  buscaEl.addEventListener("input", () => {
    clearTimeout(timer);
    timer = setTimeout(async () => {
      const q = buscaEl.value.trim();
      sugestoes.innerHTML = "";

      if (!q) {
        await carregar("");
        return;
      }

      try {
        const sug = await api(`/api/songs/suggest?q=${encodeURIComponent(q)}`, { method: "GET" });
        sugestoes.innerHTML = sug.map(s => `<div class="sug">${s}</div>`).join("");

        document.querySelectorAll(".sug").forEach(el => {
          el.style.cursor = "pointer";
          el.onclick = async () => {
            buscaEl.value = el.textContent;
            sugestoes.innerHTML = "";
            await carregar(buscaEl.value.trim());
          };
        });
      } catch {
        // sem sugestões, ok
      }

      await carregar(q);
    }, 250);
  });

  logoutBtn.onclick = () => {
    localStorage.removeItem("token");
    window.location.href = "index.html";
  };

  status.innerText = "Logado.";
  carregar("");
</script>

</body>
</html>
